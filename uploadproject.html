<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name='viewport' content='width=device-width, height=device-height, initial-scale=1'>
    <title>Upload</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="index.js"></script>
    <script src="js/toast.js"></script>
</head>

<body>

    <div class="page-container">
        <nav id="nav-placeholder"></nav>
        <script src="js/loadNav.js"></script>


        <main style="padding-left:30px;">
            <br>
            <h1>Upload project</h1>
            <div id="toast-container">

            </div>
            <style>
                #uploadForm {
                    max-width: 80vw;
                    margin: 60px auto;
                    padding: 30px;
                    background: #211b25;
                    color: #eee;
                    border-radius: 12px;
                    font-family: sans-serif;
                    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
                    box-sizing: border-box;
                }


                form input,
                form textarea {
                    width: 100%;
                    padding: 14px;
                    margin: 12px 0;
                    border: none;
                    border-radius: 6px;
                    background: #312335;
                    color: #fff;
                    font-size: 15px;
                    box-sizing: border-box;
                }

                form textarea {
                    resize: vertical;
                    min-height: 100px;
                }

                form button {
                    padding: 12px 20px;
                    margin-top: 16px;
                    background: #693675;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 16px;
                    cursor: pointer;
                    transition-duration: 0.15s;
                }

                form button:hover {
                    background: #45a049;
                }
            </style>

            <div style="display: flex; gap:30px;">
                <!--<form id="loginForm" style="max-width: 300px; margin: 40px auto; font-family: sans-serif;">
                    <input type="text" name="username" placeholder="Username" required
                        style="width:100%; padding:8px; margin-bottom:10px;">
                    <input type="password" name="password" placeholder="Password" required
                        style="width:100%; padding:8px; margin-bottom:10px;">
                    <button type="submit"
                        style="width:100%; padding:10px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">
                        Login
                    </button>
                </form>

                <script>
                    document.getElementById('loginForm').addEventListener('submit', function (e) {
                        e.preventDefault();

                        const form = e.target;
                        const data = {
                            username: form.username.value.trim(),
                            password: form.password.value.trim()
                        };

                        fetch('https://api.meisite.xyz/api/checkpassword', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        })
                            .then(res => res.json())
                            .then(success => {
                                if (success === true) {
                                    alert("Login successful!");
                                    
                                } else {
                                    alert("Login failed: Incorrect username or password.");
                                }
                            })
                            .catch(() => alert("Error checking login."));
                    });
                </script>
            -->
                <form id="uploadForm">
                    <h2>GUIDELINES <a href="uploadrules.html">HERE</a></h2>

                    <div style="display: flex; gap: 30px;">
                        <div>
                            <label>Use no title to delete a project.<br></label>
                            <label>Youtube videos only + it has to be the ID, not the URL!!<br></label>
                            <label>Use image/gif URLS (direct) for images.<br></label>
                            <label>Hit enter on the author field to turn the project grid into a "picker"-<br>-with only that author's projects, click to edit it.<br>Cloning projects is prohibited and will get you banned<br></label>
                            <label><a href="emojis.html">List of emojis</a></label>
                            <input type="text" name="id" placeholder="Project ID" required>
                            <input type="text" name="title" placeholder="Title">
                            <textarea name="description" placeholder="Description" rows="4" required></textarea>
                            <input type="text" name="summary" placeholder="Summary">
                            <input type="text" name="videoId"
                                placeholder="YouTube Video ID (Not required, but its nice to use a video.)">
                            <script>
                                async function uploadFile(file) {
                                    const formData = new FormData();
                                    formData.append("file", file); // 'file' matches request.files.get("file")

                                    const response = await fetch("https://api.meisite.xyz/api/uploadfile", {
                                        method: "POST",
                                        body: formData,
                                    });

                                    if (!response.ok) {
                                        alert("upload failed:" + await response.text());
                                        return;
                                    }

                                    const result = await response.json();
                                    console.log("server response:" + result);
                                    return result
                                }
                            </script>
                            <input type="file" accept="image/*" id="fileInput"
                                style="height: 250px; width: 250px; align-content: center; border: dashed; background-color: #44384e3b; border-color: #4c4553a6;">
                            <br>
                            <a href="#fileInput" id="fileLink">You can use this uploader for thumbnails and images.
                                Returns a URL for you to use.</a>
                            <br>
                            <button type="button" style="font-size: small;" id="uploadthefile">upload! (link should
                                appear a few seconds after upload)</button>
                            <script>
                                const filelinke = document.getElementById("fileLink");
                                const filein = document.getElementById("fileInput");
                                const button = document.getElementById("uploadthefile");
                                button.addEventListener("click", (e) => {
                                    const file = filein.files[0];
                                    if (file) {
                                        uploadFile(file).then(res => {
                                            filelinke.href = res.url;
                                            filelinke.innerText = res.url;
                                        });
                                    }
                                });
                            </script>
                            <input type="text" name="thumbnail" placeholder="Thumbnail URL" required>
                            <input type="text" name="images" placeholder="Image URLs (comma-separated)" required>
                            <hr>
                            <label>For editing/removing posts:</label>
                            <input type="text" id="namearea" name="author"
                                placeholder="Author (your name, please keep this persistent and simplee between posts for easy filtering)"
                                required>
                            <input type="text" name="password" placeholder="Password" required>
                            <script>
                                const nameInput = document.getElementById("namearea");
                                let selectedProject = undefined;

                                function pickProject(project) {
                                    selectedProject = project; // full object with id
                                    toastnotify("meow. selected " + project.title);

                                    // optionally populate the form fields with the project data
                                    const form = document.getElementById("uploadForm");
                                    form.id.value = project.id;
                                    form.title.value = project.title || "";
                                    form.description.value = project.description || "";
                                    form.summary.value = project.summary || "";
                                    form.videoId.value = project.video || "";
                                    form.thumbnail.value = project.thumbnail || "";
                                    form.images.value = (project.images || []).join(", ");
                                    form.author.value = project.author || "";
                                }

                                // fetch projects for a specific author
                                nameInput.addEventListener("keydown", e => {
                                    if (e.key !== "Enter") return;
                                    e.preventDefault();

                                    fetch('https://api.meisite.xyz/api/uploads?author=' + encodeURIComponent(nameInput.value))
                                        .then(res => res.json())
                                        .then(projects => {
                                            const grid = document.querySelector('.grid');
                                            if (!grid) return console.error("No .grid container found!");
                                            grid.innerHTML = "";
                                            toastnotify("Pick a project");

                                            for (const [id, project] of Object.entries(projects)) {
                                                const projWithId = { ...project, id }; // attach key as id
                                                const item = document.createElement('a');
                                                item.href = "#";
                                                item.classList.add('grid-item-wrapper');
                                                item.dataset.project = JSON.stringify(projWithId);

                                                item.innerHTML = `
                                                        <div class="grid-item">
                                                            <img src="${project.thumbnail}" alt="${project.title}">
                                                            <div class="overlay"></div>
                                                            <div class="title">${project.title}</div>
                                                            <span class="subtitle">${project.summary}</span>
                                                        </div>
                                                    `;

                                                item.addEventListener('click', () => {
                                                    const proj = JSON.parse(item.dataset.project);
                                                    pickProject(proj);
                                                });

                                                grid.appendChild(item);
                                            }
                                        })
                                        .catch(err => console.error("Failed to fetch projects:", err));
                                });
                            </script>
                        </div>
                        <button type="submit">Upload</button>
                    </div>
                </form>
            </div>

            <script>


                let careNot = 0
                document.getElementById('uploadForm').addEventListener('submit', function (e) {
                    e.preventDefault();

                    if (localStorage.getItem("rulesRead") != "sure yeah i guess") {
                        alert("You haven't read the guidelines!");
                    }

                    const form = e.target;
                    const data = {
                        id: form.id.value,
                        title: form.title.value,
                        description: form.description.value,
                        summary: form.summary.value,
                        videoId: form.videoId.value,
                        thumbnail: form.thumbnail.value,
                        images: form.images.value.split(',').map(s => s.trim()),
                        username: form.author.value,
                        password: form.password.value
                    };

                    fetch('https://api.meisite.xyz/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })
                        .then(res => res.json())
                        .then(response => {
                            if (response.status === 'success') {
                                location.reload();
                            } else {
                                alert(response.reason);
                            }
                        });
                });
            </script>



            <div class="grid">
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    fetch('https://api.meisite.xyz/api/uploads')
                        .then(res => res.json())
                        .then(projects => {
                            const grid = document.querySelector('.grid');
                            if (!grid) return console.error("No .grid container found!");

                            for (const [id, project] of Object.entries(projects)) {
                                const item = document.createElement('a');
                                item.href = `userproject.html?id=${id}`;
                                item.innerHTML = `
                                    <div class="grid-item">
                                        <img src="${project.thumbnail}" alt="${project.title}">
                                        <div class="overlay"></div>
                                        <div class="title">${project.title}</div>
                                        <span class="subtitle">${project.summary}</span>
                                    </div>`;
                                grid.appendChild(item);
                            }
                        });
                });


            </script>
        </main>

        <footer style="font-family: monospace;" id="footer-placeholder"></footer>
        <script src="js/loadFooter.js"></script>

    </div>


</body>

</html>