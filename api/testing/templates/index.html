<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>flask websocket chat</title>
	<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
	<script src="toast.js"></script>
	<style>
		body {
			font-family: sans-serif;
			max-width: 400px;
			margin: 20px auto;
		}

		#chat {
			border: 1px solid #ccc;
			height: 300px;
			overflow-y: auto;
			padding: 5px;
			margin-bottom: 10px;
			background: #f9f9f9;
			border-radius: 5px;
		}

		#msgInput,
		#nameInput {
			width: 100%;
			padding: 8px;
			box-sizing: border-box;
			border-radius: 5px;
			border-style: solid;
			border-width: 1px;
		}

		.msg {
			padding: 2px 0;
		}
	</style>
</head>

<body>
	<div id="toast-container">

	</div>
	<h3>simple chat</h3>
	<div id="chat"></div>
	<input id="msgInput" type="text" placeholder="type a message and hit enter...">
	<input id="nameInput" type="text" placeholder="your name here">
	<p id="alerter"></p>

	<script>
		function parseColors(msg) {
			return msg.replace(/<#[0-9A-Fa-f]{6}>(.*?)<\/>/g, (full, text) => {
				const color = full.slice(1, 8); // "#FF0000"
				return `<span style="color:${color}">${text}</span>`;
			});
		}

		function escapeHtml(str) {
			return str.replace(/[&<>"']/g, match => ({
				'&': '&amp;',
				'<': '&lt;',
				'>': '&gt;',
				'"': '&quot;',
				"'": '&#39;'
			}[match]));
		}

	</script>

	<script>
		const socket = io("https://api.meisite.xyz/");
		const chat = document.getElementById('chat');
		const input = document.getElementById('msgInput');
		const nameinput = document.getElementById('nameInput');
		const alerter = document.getElementById('alerter');
		let name = "";
		let lastmessage = "";

		socket.on('message', (msg) => {
			const div = document.createElement('div');
			div.className = 'msg';
			div.innerHTML = parseColors(msg);
			chat.appendChild(div);
			chat.scrollTop = chat.scrollHeight; // auto-scroll down
		});

		input.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && input.value.trim() !== '') {
				socket.send(input.value);
				lastmessage = input.value;
				input.value = '';
				if (name == "") {
					alerter.innerText = 'You need to set a name first.';
				}
			}
			if (e.key === 'ArrowUp') {
				input.value = lastmessage;
			}
		});

		nameinput.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && nameinput.value.trim() !== '') {
				socket.send("-NAME-= " + nameinput.value);
				name = nameinput.value;
				alerter.innerText = 'Name set to: ' + name;
			}
		});


	</script>
</body>

</html>