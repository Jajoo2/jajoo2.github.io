<!doctype html>
<html>

<head>
	<meta charset=utf-8>
	<meta name='viewport' content='width=device-width, height=device-height, initial-scale=1'>
	<title>Meisite Chat</title>
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<script src="js/script.js"></script>
	<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
	<style>
		body {
			background-color: #0c090f;
		}

		.chat-main {
			position: relative;
			/* Allows absolute positioning inside */
		}

		.members-container {
			position: absolute;
			top: 10px;
			right: 10px;
			background: rgba(20, 15, 25, 0.8);
			border: 1px solid #332a3d;
			padding: 10px;
			border-radius: 8px;
			width: 150px;
			max-height: 200px;
			overflow-y: auto;
			z-index: 100;
			font-size: 0.8em;
		}

		.members-container h4 {
			margin: 0 0 8px 0;
			color: #888;
			text-transform: uppercase;
			font-size: 0.7rem;
		}

		.member-item {
			color: #00ffcc;
			/* Or whatever your theme color is */
			margin-bottom: 4px;
		}
	</style>
</head>

<body>
	<div style="display: flex;">
		<div class="sidebar" id="sidebar"></div>

		<div id="toast-container"></div>
		<div class="content">
			<div class="chat-layout">
				<div class="chat-channels" id="channelshit">
					<!--<div class="chat-channel"># general</div>-->
				</div>

				<div class="chat-main">
					<div class="members-container">
						<h4>Online — <span id="member-count">0</span></h4>
						<div id="members-list"></div>
					</div>
					<div class="chat-messages">
						<div class="thingyard_comment">
							<span style="color:#cccccc65;font-size:smaller;">system</span>
							<p>welcome</p>
						</div>
					</div>
					<form id="chatform">
						<div class="chat-input">
							<textarea name="msg" autocomplete="off" style="width: 100%; outline: none;" type="text"
								placeholder="type message..."></textarea>
							<button type="submit">send</button>
						</div>
					</form>
					<script>
						const form = document.getElementById("chatform");
						const input = form.querySelector("textarea[name='msg']");
						const chatMessages = document.querySelector(".chat-messages");
						const listContainer = document.getElementById("members-list");
						const countDisplay = document.getElementById("member-count");

						input.addEventListener("keydown", e => {
							if (e.key === "Enter" && !e.shiftKey) {
								e.preventDefault();        // prevent newline
								form.dispatchEvent(new Event("submit", { cancelable: true })); // trigger your submit handler
							}
						});



						let currentChannel = "general";
						let username = localStorage.getItem("user") || "Anonymous";

						// Connect
						const socket = io("https://api.meisite.xyz");

						// Helper to handle joining a channel
						function joinChannel(channelName) {
							currentChannel = channelName;
							chatMessages.innerHTML = "";
							// Tell server we joined AND give them our username
							socket.emit("join", {
								channel: currentChannel,
								username: username
							});
						}

						// Fetch channels and build sidebar
						async function getUserMoralValues() {
							try {
								const r = await fetch('https://api.meisite.xyz/channels');
								if (!r.ok) throw new Error('bad :(');
								const data = await r.json();

								const container = document.getElementById("channelshit");
								container.innerHTML = "";

								data.forEach(channel => {
									const div = document.createElement("div");
									div.classList.add("chat-channel");
									if (channel === currentChannel) div.classList.add("active");
									div.textContent = `# ${channel}`;
									container.appendChild(div);

									div.addEventListener("click", () => {
										const active = container.querySelector(".chat-channel.active");
										if (active) active.classList.remove("active");

										div.classList.add("active");
										joinChannel(channel);
									});
								});
							} catch (e) {
								console.log('err:', e);
							}
						}

						// 1. Initial Load
						getUserMoralValues();
						joinChannel(currentChannel);

						// 2. Listen for Member List updates
						socket.on("room_users", users => {
							countDisplay.textContent = users.length;
							listContainer.innerHTML = "";

							users.forEach(user => {
								const div = document.createElement("div");
								div.classList.add("member-item");
								div.textContent = `• ${user}`;
								listContainer.appendChild(div);
							});
						});

						// 3. Handle sending messages
						form.addEventListener("submit", e => {
							e.preventDefault();
							const msg = input.value.trim();
							if (!msg) return;

							socket.emit("message", {
								channel: currentChannel,
								author: username,
								content: msg
							});
							input.value = "";
						});

						// 4. Receive new message
						socket.on("message", data => {
							const div = document.createElement("div");
							div.classList.add("thingyard_comment");
							div.innerHTML = `<span style="color:#cccccc65;font-size:smaller;">${data.author}</span><p>${data.content}</p>`;
							chatMessages.appendChild(div);
							chatMessages.scrollTop = chatMessages.scrollHeight;
						});

						// 5. Receive chat history
						socket.on("history", msgs => {
							chatMessages.innerHTML = "";
							msgs.forEach(m => {
								const div = document.createElement("div");
								div.classList.add("thingyard_comment");
								div.innerHTML = `<span style="color:#cccccc65;font-size:smaller;">${m.author}</span><p>${m.content}</p>`;
								chatMessages.appendChild(div);
							});
							chatMessages.scrollTop = chatMessages.scrollHeight;
						});
					</script>
				</div>
			</div>
		</div>
	</div>

</body>

</html>