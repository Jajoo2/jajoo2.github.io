<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>meichat</title>
	<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
	<script src="js/toast.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css" />
	<style>
		#chat {
			width: 50vw;
			height: 80vh;
			overflow-y: auto;
			padding: 15px;
			background: #00000075;
			margin-bottom: 10px;
		}

		.tinput {
			width: 100%;
			padding: 8px;
			box-sizing: border-box;
			border-radius: 5px;
			border-style: none;
			background-color: #00000075;
			color: #ccc;
			width: 50vw;
			font-family: 'Comfortaa';
		}

		.msg {
			padding: 2px 0;
			white-space: break-spaces;
		}

		main {
			display: flex;
			flex-direction: column;
			margin: 10px;
			align-items: center;
		}

		@media (max-width: 700px) 
		{
			#chat {
				width: 85vw;
				height: 45vh;
				overflow-y: auto;
				padding: 15px;
				background: #00000075;
				margin-bottom: 10px;
			}
			.tinput {
				width: 65vw;
			}
		}
	</style>
</head>

<body>
	<div class="page-container">
		<div id="toast-container"></div>
		<nav id="nav-placeholder"></nav>
		<script src="js/loadNav.js"></script>
		<main>
			<div id="user-extensions"></div>
			<div id="chat"></div>
			<textarea class="tinput" id="msgInput" placeholder="type a message and hit enter..."></textarea>
			<div style="height: 10px;"></div>
			<textarea class="tinput" id="nameInput" placeholder="your name here"></textarea>
			<div style="height: 10px;"></div>
			<textarea class="tinput" id="template" placeholder="message template ($msg is your message)"></textarea>
			

			<script>
				function replaceEmojiCodes(text) {
					return text.replace(/:([a-zA-Z0-9_-]+):/g, (match, filename) => {
						return `<span style="display:inline-flex; align-items:center; vertical-align:middle;">
							<img src="img/emoji/${filename}.gif" alt="${filename}" style="height:1.5em; width:auto;"/>
						</span>`;
					});
				}
				function parseColors(msg) {
					return msg.replace(/<#[0-9A-Fa-f]{6}>(.*?)<\/>/gs, (full, text) => {
						const color = full.slice(1, 8); // "#FF0000"
						return `<span style="color:${color}">${text}</span>`;
					});
				}

				function escapeHtml(str) {
					return str.replace(/[&<>"']/g, match => ({
						'&': '&amp;',
						'<': '&lt;',
						'>': '&gt;',
						'"': '&quot;',
						"'": '&#39;'
					}[match]));
				}

			</script>

			<script>
				const socket = io("https://api.meisite.xyz/");
				const chat = document.getElementById('chat');
				const input = document.getElementById('msgInput');
				const nameinput = document.getElementById('nameInput');
				const alerter = document.getElementById('alerter');
				const template = document.getElementById('template');

				template.value = localStorage.getItem('template');
				let name = localStorage.getItem('name');
				if(name)
				{
					socket.send("-NAME-= " + name); // Please work.
				}
				nameinput.value = name;
				let lastmessage = "";

				socket.on('message', (msg) => {
					const div = document.createElement('div');
					div.className = 'msg';
					div.innerHTML = replaceEmojiCodes(parseColors(msg));
					chat.appendChild(div);
					chat.scrollTop = chat.scrollHeight; // auto-scroll down
				});

				input.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' && !e.shiftKey) {
						e.preventDefault(); // block normal enter
						if(!template.value)
						{
							socket.send(input.value);
						}else
						{
							socket.send(template.value.replace("$msg",input.value));
						}
						lastmessage = input.value;
						input.value = '';
						if (name == "") {
							toastnotify("You need a name.");
						}
					}
					if (e.key === 'ArrowUp') {
						input.value = lastmessage;
					}
				});

				nameinput.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' && e.ctrlKey && nameinput.value.trim() !== '') {
						socket.send("-NAME-= " + nameinput.value);
						name = nameinput.value;
						toastnotify("Name changed to: "+name);
						localStorage.setItem('name', name);
					}
				});

				template.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' && e.ctrlKey && template.value.trim() !== '') {
						toastnotify("Saved template");
						localStorage.setItem('template', template.value);
					}
				});


				const userExtensionsContainer = document.getElementById('user-extensions');
					const activeExtensionSockets = {};

					// The passive class that holds listeners for an extension instance.
					class ChatSocket {
						constructor(extensionId) {
							this.extensionId = extensionId;
							this.listeners = {};
						}

						on(type, callback) {
							if (!this.listeners[type]) {
								this.listeners[type] = [];
							}
							this.listeners[type].push(callback);
						}

						send(type, body) {
							socket.emit('extension_message', {
								from: this.extensionId,
								type: type,
								body: body
							});
						}
					}

					// The global factory function that extensions will call.
					function getChatSocket(extensionId) {
						// If an old instance exists for this ID, simply delete it from our manager.
						// It will be garbage collected, and its listeners will no longer be called.
						if (activeExtensionSockets[extensionId]) {
							delete activeExtensionSockets[extensionId];
						}
						// Create and register the new instance.
						const newSocket = new ChatSocket(extensionId);
						activeExtensionSockets[extensionId] = newSocket;
						return newSocket;
					}
					window.getChatSocket = getChatSocket;

					// The single, centralized dispatcher. It listens for broadcasts
					// and routes them to the correct active extension instances.
					socket.on('extension_broadcast', (data) => {
						// data should be { from: 'some-ext-id', type: 'some-type', body: ... }
						if (!data || !data.type) return;

						Object.values(activeExtensionSockets).forEach(instance => {
							if (instance.listeners[data.type]) {
								instance.listeners[data.type].forEach(callback => {
									try {
										callback(data.body, data.from); // Pass body and sender ID
									} catch (e) {
										console.error(`Error in extension '${instance.extensionId}' handling event '${data.type}':`, e);
									}
								});
							}
						});
					});

					// --- DOM Management Functions ---
					function loadExtension(id, content) {
						// First, ensure any old version is completely removed.
						removeExtension(id);

						const extensionWrapper = document.createElement('div');
						extensionWrapper.id = `user-extension-${id}`;
						extensionWrapper.innerHTML = content;
						userExtensionsContainer.appendChild(extensionWrapper);
					}

					function removeExtension(id) {
						// Remove the socket instance from the manager. It's now inert.
						if (activeExtensionSockets[id]) {
							delete activeExtensionSockets[id];
						}
						// Remove the element from the DOM.
						const element = document.getElementById(`user-extension-${id}`);
						if (element) {
							element.remove();
						}
					}

					// --- Real-time Handlers for Extension Updates ---
					socket.on('extension_updated', (data) => {
						console.log(`Loading extension: ${data.id}`);
						loadExtension(data.id, data.content);
					});

					socket.on('extension_removed', (data) => {
						console.log(`Removing extension: ${data.id}`);
						removeExtension(data.id);
					});

					// --- Initial Load ---
					async function fetchAndLoadExtensions() {
						try {
							const response = await fetch('https://api.meisite.xyz/api/extensions');
							const extensions = await response.json();
							for (const [id, content] of Object.entries(extensions)) {
								loadExtension(id, content);
							}
						} catch (error) {
							console.error('Failed to load extensions:', error);
						}
					}

					// Fetch extensions once the main socket is connected.
					socket.on('connect', () => {
						fetchAndLoadExtensions();
					});
			</script>
		</main>
		<footer style="font-family: monospace;" id="footer-placeholder"></footer>
		<script src="js/loadFooter.js"></script>
	</div>
</body>

</html>